# CLI工具模块 核心流程

## 主流程: 初始化项目 (ai-dev init)

```mermaid
graph TD
    A[用户运行 ai-dev init] --> B{检查环境}
    B -->|Node.js < 14| C[提示升级Node.js]
    B -->|Node.js >= 14| D[显示欢迎信息]
    D --> E[询问: 选择项目类型]
    E --> F[显示模板列表]
    F --> G[用户选择模板]
    G --> H[询问: 项目名称]
    H --> I[询问: 项目描述]
    I --> J{检查目标目录}
    J -->|目录已存在| K[提示错误或询问覆盖]
    J -->|目录不存在| L[创建项目目录]
    K -->|取消| M[退出]
    K -->|覆盖| L
    L --> N[复制基础模板]
    N --> O[复制项目类型模板]
    O --> P[生成 README.md]
    P --> Q[初始化 Git]
    Q --> R[创建初始文档结构]
    R --> S[显示成功提示]
    S --> T[显示下一步指引]
    T --> U[结束]
```

## 子流程1: 模板选择

```mermaid
graph LR
    A[显示模板列表] --> B{用户选择}
    B -->|Web 全栈| C[设置 needsPrototype=true]
    B -->|移动应用| D[设置 needsPrototype=true]
    B -->|后端 API| E[设置 needsPrototype=false]
    B -->|CLI 工具| F[设置 needsPrototype=false]
    C --> G[记录选择]
    D --> G
    E --> G
    F --> G
```

## 子流程2: 目录冲突处理

```mermaid
graph TD
    A{目标目录存在?} -->|否| B[直接创建]
    A -->|是| C{目录为空?}
    C -->|是| B
    C -->|否| D[询问用户]
    D -->|覆盖| E[清空目录]
    D -->|取消| F[退出]
    D -->|重命名| G[输入新名称]
    E --> B
    G --> A
```

## 异常流程

| 异常场景 | 触发条件 | 系统行为 | 用户感知 |
|---------|---------|---------|---------|
| Node.js版本过低 | node --version < 14 | 阻止执行 | 红色错误提示 + 升级指引 |
| 网络连接失败 | npm registry 不可达 | 降级到离线模式 | 警告提示，使用本地模板 |
| 磁盘空间不足 | 剩余空间 < 100MB | 阻止执行 | 红色错误提示 |
| 权限不足 | 无法写入目标目录 | 阻止执行 | 权限错误提示 + 解决方案 |
| 模板损坏 | 模板文件缺失 | 重新下载或报错 | 错误提示 + 重试选项 |

## 业务规则

### BR-001: 项目命名规则
- **规则**: 项目名称必须符合 npm 包命名规范
- **格式**: 小写字母、数字、连字符、下划线
- **长度**: 1-214个字符
- **校验**: 使用 `validate-npm-package-name` 库

### BR-002: 目录结构规则
```
{project-name}/
├── .claude/
│   ├── skills/
│   └── settings.json
├── CLAUDE.md
├── docs/
│   ├── modules/
│   ├── architecture/
│   └── trackers/
├── README.md
└── .gitignore
```

### BR-003: Git初始化规则
- 自动 `git init`
- 自动创建 `.gitignore`
- 不自动创建首次提交（留给用户决定）

### BR-004: 模板合并规则
1. 先复制基础模板（完整复制）
2. 再复制项目类型模板（覆盖同名文件）
3. 保留项目类型模板的特殊配置

## 状态机

```mermaid
stateDiagram-v2
    [*] --> Idle: 启动CLI
    Idle --> Prompting: 开始询问
    Prompting --> Validating: 用户输入完成
    Validating --> Prompting: 校验失败
    Validating --> Installing: 校验通过
    Installing --> Success: 安装成功
    Installing --> Failed: 安装失败
    Success --> [*]
    Failed --> [*]
    Failed --> Idle: 用户选择重试
```

## 性能要求

| 操作 | 性能目标 | 测量方法 |
|------|---------|---------|
| 显示模板列表 | < 100ms | 从启动到显示 |
| 复制基础模板 | < 2秒 | 文件复制耗时 |
| 完整项目创建 | < 5秒 | 从确认到成功提示 |
| 内存占用 | < 100MB | 运行时内存峰值 |

## 用户体验细节

### 交互设计
- ✅ 使用颜色区分不同类型的提示（成功=绿色、错误=红色、警告=黄色）
- ✅ 显示进度指示器（Spinner）
- ✅ 关键步骤显示 ✓ 标记
- ✅ 提供清晰的下一步指引

### 错误提示格式
```
❌ 错误: {错误描述}

原因: {具体原因}

解决方案:
  1. {解决步骤1}
  2. {解决步骤2}

更多帮助: https://github.com/xxx/issues
```

---

**文档版本**: v1.0
**创建日期**: 2025-12-10
